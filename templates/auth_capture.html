{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow">
                <div class="card-header bg-success text-white">
                    <h4 class="mb-0"><i class="fas fa-check-circle me-2"></i> Código de Autorización Capturado</h4>
                </div>
                <div class="card-body">
                    <div class="alert alert-success" id="captureSuccess">
                        <i class="fas fa-info-circle me-2"></i> Procesando su código de autorización...
                    </div>
                    <div class="alert alert-danger d-none" id="captureError">
                        <i class="fas fa-exclamation-triangle me-2"></i> <span id="errorMessage">Error al procesar el código de autorización.</span>
                    </div>

                    <h5 class="mb-3">Su código de autorización:</h5>
                    <div class="bg-dark p-3 rounded mb-3" style="font-family: monospace; word-break: break-all;">
                        <div class="spinner-border spinner-border-sm text-secondary" role="status" id="codeSpinner">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <span id="authCode">Extrayendo código...</span>
                    </div>

                    <div id="manualForm" class="d-none">
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i> El procesamiento automático falló. Por favor, envíe el código manualmente haciendo clic en el botón de abajo.
                        </div>
                        <form id="codeForm" method="post" action="{{ url_for('auth_complete') }}">
                            <input type="hidden" name="code" id="codeInput">
                            <input type="hidden" name="redirect_uri" id="redirectUriInput" value="{{ redirect_uri }}">
                            <input type="hidden" name="_is_form" value="true">
                            <div class="d-grid mt-3">
                                <button type="submit" class="btn btn-lg btn-primary">
                                    <i class="fas fa-paper-plane me-2"></i> Enviar código manualmente
                                </button>
                            </div>
                        </form>
                        <div class="text-center mt-3">
                            <small class="text-muted">Si continúa teniendo problemas, contacte al administrador del sistema.</small>
                        </div>
                    </div>

                    <div class="text-center mt-4" id="redirectMessage">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Redireccionando...</span>
                        </div>
                        <p class="mt-2">Será redireccionado automáticamente al dashboard en <span id="countdown">5</span> segundos...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Extraer el código de autorización de la URL
    const urlParams = new URLSearchParams(window.location.search);
    const code = urlParams.get('code');
    const state = urlParams.get('state');
    const authCodeEl = document.getElementById('authCode');
    const codeSpinner = document.getElementById('codeSpinner');
    const captureSuccess = document.getElementById('captureSuccess');
    const captureError = document.getElementById('captureError');
    const errorMessage = document.getElementById('errorMessage');
    const manualForm = document.getElementById('manualForm');
    const codeInput = document.getElementById('codeInput');
    const redirectMessage = document.getElementById('redirectMessage');
    const countdown = document.getElementById('countdown');
    
    // Ocultar el mensaje de redirección inicialmente
    redirectMessage.classList.add('d-none');
    
    if (code) {
        // Mostrar el código obtenido
        codeSpinner.classList.add('d-none');
        authCodeEl.textContent = code;
        
        // Establecer el código en el formulario manual (por si acaso)
        if (codeInput) {
            codeInput.value = code;
        }
        
        // Determinar la URL base
        let baseUrl = window.location.origin;
        // Si estamos en un proxy HTTPS pero la URL es HTTP, corregirla
        if (window.location.href.includes('https') && baseUrl.startsWith('http:')) {
            baseUrl = baseUrl.replace('http:', 'https:');
        }
        
        // Obtener la URL de redirección del formulario o usarla desde la plantilla
        const redirectUri = document.getElementById('redirectUriInput').value || "{{ redirect_uri }}";
        
        // Intentar enviar el código automáticamente al servidor
        fetch(`${baseUrl}/auth-complete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
                'Accept': 'application/json'
            },
            body: new URLSearchParams({
                'code': code,
                'state': state,
                'redirect_uri': redirectUri
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Mostrar mensaje de éxito
                captureSuccess.innerHTML = '<i class="fas fa-check-circle me-2"></i> Código de autorización procesado con éxito.';
                
                // Iniciar cuenta regresiva para la redirección
                redirectMessage.classList.remove('d-none');
                let count = 5;
                countdown.textContent = count;
                
                const interval = setInterval(() => {
                    count--;
                    countdown.textContent = count;
                    if (count <= 0) {
                        clearInterval(interval);
                        window.location.href = data.redirect;
                    }
                }, 1000);
            } else {
                // Mostrar advertencia
                captureSuccess.innerHTML = '<i class="fas fa-exclamation-circle me-2"></i> ' + (data.warning || 'Advertencia: Procesamiento automático con problemas.');
                // Mostrar formulario manual
                manualForm.classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('Error al enviar código automáticamente:', error);
            captureSuccess.classList.add('d-none');
            captureError.classList.remove('d-none');
            errorMessage.textContent = 'Error al procesar el código. Se mostrará el formulario manual.';
            
            // Mostrar el formulario de ingreso manual
            manualForm.classList.remove('d-none');
            
            // Asegurar que el código esté correcto en el formulario manual
            if (codeInput) {
                codeInput.value = code;
            }
            if (document.getElementById('redirectUriInput')) {
                document.getElementById('redirectUriInput').value = redirectUri;
            }
        });
    } else {
        // No se encontró código
        codeSpinner.classList.add('d-none');
        authCodeEl.textContent = 'No se encontró un código de autorización en la URL.';
        captureSuccess.classList.add('d-none');
        captureError.classList.remove('d-none');
        errorMessage.textContent = 'No se encontró un código de autorización en la URL.';
    }
});
</script>
{% endblock %}