{% extends 'base.html' %}

{% block extra_css %}
<style>
    #map {
        height: 500px;
        width: 100%;
        border-radius: 5px;
    }
    
    .machine-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .machine-item:hover {
        background-color: var(--bs-gray-800);
    }
    
    .machine-item.active {
        background-color: var(--bs-primary) !important;
        color: white;
    }
    
    .alert-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 0.7rem;
    }
    
    .alert-severity-critical {
        color: var(--bs-danger);
    }
    
    .alert-severity-warning {
        color: var(--bs-warning);
    }
    
    .alert-severity-info {
        color: var(--bs-info);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h1 class="display-5">Dashboard de Máquinas</h1>
    </div>
    <div class="col-md-4 text-end">
        <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="organizationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-building me-2"></i> Seleccionar Organización
            </button>
            <div class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="organizationDropdown" style="width: 300px;">
                <div class="mb-2">
                    <input type="text" class="form-control form-control-sm" id="orgSearchInput" placeholder="Buscar organización..." autocomplete="off">
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <ul class="list-unstyled mb-0" id="organizationList">
                        {% for org in organizations %}
                        <li><a class="dropdown-item organization-item" href="#" data-org-id="{{ org.id }}">{{ org.name }}</a></li>
                        {% endfor %}
                    </ul>
                    <div id="noResultsMessage" class="text-center p-2 d-none">
                        <span class="text-muted">No se encontraron resultados</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if token_info %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow bg-dark">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-key me-2"></i> Información de Autenticación
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Access Token:</strong> <span>{{ token_info.access_token }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Refresh Token:</strong> <span>{{ token_info.refresh_token }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Expira en:</strong> <span>{{ token_info.expires_in }}</span>
                        </div>
                    </div>
                    <div class="col-md-3 text-end">
                        <a href="{{ url_for('auth_setup') }}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-cog me-1"></i> Configurar autenticación
                        </a>
                    </div>
                </div>
                
                {% if auth_code_info %}
                <hr class="border-secondary">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <strong>Último código de autorización:</strong> 
                            <span class="user-select-all">{{ auth_code_info.code }}</span>
                            <span class="badge bg-info ms-1">{{ auth_code_info.full_length }} caracteres</span>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-muted">Este código fue utilizado para obtener el token actual. Guárdelo como referencia.</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<div class="row">
    <div class="col-md-4">
        <div class="card shadow mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-tractor me-2"></i> Máquinas
                </h5>
                <span class="badge bg-primary" id="machineCount">0</span>
            </div>
            <div class="card-body p-0">
                <div id="machineSearchContainer" class="p-2 border-bottom d-none">
                    <input type="text" class="form-control form-control-sm" id="machineSearchInput" placeholder="Buscar máquina..." autocomplete="off">
                </div>
                <div id="machineListContainer" class="list-group list-group-flush machine-list" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center py-5">
                        <div class="spinner-border text-secondary d-none" id="machineLoader" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-3" id="emptyMachineMessage">Seleccione una organización para ver sus máquinas</p>
                    </div>
                </div>
                <div id="noMachineResultsMessage" class="text-center py-3 d-none">
                    <span class="text-muted">No se encontraron máquinas con ese criterio</span>
                </div>
            </div>
        </div>
        
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bell me-2"></i> Alertas
                </h5>
            </div>
            <div class="card-body p-0">
                <div id="alertListContainer" class="list-group list-group-flush alert-list" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center py-5">
                        <p class="text-muted" id="emptyAlertMessage">Seleccione una máquina para ver sus alertas</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card shadow mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-map-marker-alt me-2"></i> Ubicación de Máquinas
                </h5>
            </div>
            <div class="card-body">
                <div id="map"></div>
            </div>
        </div>
        
        <div class="card shadow" id="machineDetailCard">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i> Detalles de la Máquina
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center py-4" id="machineDetailEmpty">
                    <p class="text-muted">Seleccione una máquina para ver sus detalles</p>
                </div>
                <div id="machineDetailContent" class="d-none">
                    <div class="row">
                        <div class="col-md-6">
                            <h3 id="machineName">-</h3>
                            <p class="lead" id="machineModel">-</p>
                            <div class="mb-3">
                                <strong>Categoría:</strong> <span id="machineCategory">-</span>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-dark">
                                <div class="card-body">
                                    <h6>Última ubicación conocida</h6>
                                    <div class="mb-2">
                                        <strong>Latitud:</strong> <span id="machineLatitude">-</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Longitud:</strong> <span id="machineLongitude">-</span>
                                    </div>
                                    <div>
                                        <strong>Actualizado:</strong> <span id="machineLocationUpdate">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
{% endblock %}
