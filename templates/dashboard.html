{% extends 'base.html' %}

{% block extra_css %}
<style>
    :root {
        --gradient-primary: linear-gradient(135deg, #0d6efd, #0a58ca);
        --gradient-secondary: linear-gradient(135deg, #495057, #343a40);
        --gradient-dark: linear-gradient(135deg, #212529, #1a1d20);
        --gradient-info: linear-gradient(135deg, #0dcaf0, #0aa2c0);
        --gradient-danger: linear-gradient(135deg, #dc3545, #b02a37);
        --gradient-warning: linear-gradient(135deg, #ffc107, #ca9a0b);
        --card-border-radius: 0.5rem;
        --box-shadow-color: rgba(0, 0, 0, 0.5);
    }

    /* Mejoras para los paneles/cards */
    .card {
        border-radius: var(--card-border-radius) !important;
        border: none !important;
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
        transition: all 0.3s ease !important;
        overflow: hidden;
    }
    
    .card:hover {
        box-shadow: 0 12px 20px rgba(0, 0, 0, 0.25) !important;
        transform: translateY(-2px);
    }
    
    .card .card-header {
        background: var(--gradient-dark) !important;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1) !important;
        padding: 0.8rem 1.25rem !important;
    }
    
    /* Contenedor de máquinas con degradado */
    #machineListContainer {
        background: var(--gradient-secondary);
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
    }
    
    /* Contenedor de alertas con degradado */
    #alertListContainer {
        background: var(--gradient-secondary);
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2);
    }
    
    /* Mapa con borde personalizado */
    #map {
        height: 500px;
        width: 100%;
        border-radius: 8px;
        box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    /* Efecto de brillo en los bordes para paneles importantes */
    .card.shadow {
        position: relative;
        border: 1px solid rgba(255, 255, 255, 0.05) !important;
    }
    
    .card.shadow.active-card {
        border: 1px solid rgba(13, 110, 253, 0.5) !important;
        box-shadow: 0 0 20px rgba(13, 110, 253, 0.2) !important;
    }
    
    /* Mejoras para los items de máquina */
    .machine-item {
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        margin-bottom: 1px;
    }
    
    .machine-item:hover {
        background-color: rgba(255, 255, 255, 0.05);
        border-left-color: rgba(13, 110, 253, 0.5);
    }
    
    .machine-item.active {
        background: var(--gradient-primary) !important;
        color: white;
        border-left-color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
    
    /* Badge de alertas con efecto elevado */
    .alert-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        font-size: 0.7rem;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* Botones con efecto de brillo */
    .btn {
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .btn:after {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0));
        transform: rotate(30deg);
        opacity: 0;
        transition: all 0.8s ease;
    }
    
    .btn:hover:after {
        opacity: 1;
        transform: rotate(30deg) translate(20%, -20%);
    }
    
    /* Estilos de severidad de alertas */
    .alert-severity-high {
        color: var(--bs-danger); /* ROJO para HIGH */
        text-shadow: 0 0 5px rgba(220, 53, 69, 0.3);
    }
    
    .alert-severity-medium {
        color: var(--bs-warning); /* AMARILLO para MEDIUM */
        text-shadow: 0 0 5px rgba(255, 193, 7, 0.3);
    }
    
    .alert-severity-low, 
    .alert-severity-dtc,
    .alert-severity-unknown {
        color: var(--bs-secondary); /* GRIS para LOW, DTC, UNKNOWN */
    }
    
    .alert-severity-info {
        color: var(--bs-info); /* AZUL para INFO */
        text-shadow: 0 0 5px rgba(13, 202, 240, 0.3);
    }
    
    /* Clases de fondo para badges con degradados */
    .bg-severity-high {
        background: var(--gradient-danger) !important;
        box-shadow: 0 2px 5px rgba(220, 53, 69, 0.3);
    }
    
    .bg-severity-medium {
        background: var(--gradient-warning) !important;
        color: var(--bs-dark) !important;
        box-shadow: 0 2px 5px rgba(255, 193, 7, 0.3);
    }
    
    .bg-severity-low,
    .bg-severity-dtc,
    .bg-severity-unknown {
        background: var(--gradient-secondary) !important;
    }
    
    .bg-severity-info {
        background: var(--gradient-info) !important;
        box-shadow: 0 2px 5px rgba(13, 202, 240, 0.3);
    }
    
    /* Efecto de iluminación para elementos importantes */
    .card-header h5 i {
        filter: drop-shadow(0 0 2px rgba(255, 255, 255, 0.3));
    }
    
    /* Spinner personalizado */
    .spinner-border {
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.2);
    }
    
    /* Animación para transiciones suaves */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .fade-in {
        animation: fadeIn 0.3s ease forwards;
    }
</style>
{% endblock %}

{% block content %}
<!-- Título y controles -->
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="display-5">Dashboard de Máquinas</h1>
            <div class="d-flex align-items-center">
                <!-- Botón de configuración -->
                <div class="dropdown me-3">
                    <button class="btn btn-sm btn-outline-secondary" type="button" id="configDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-cog"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="configDropdown">
                        <li><a class="dropdown-item" href="#" id="toggleAuthInfo">Mostrar información de autenticación</a></li>
                    </ul>
                </div>

                <!-- Selector de organización -->
                <div class="dropdown">
                    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="organizationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="fas fa-building me-2"></i> Seleccionar Organización
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="organizationDropdown" style="width: 300px;">
                        <div class="mb-2">
                            <input type="text" class="form-control form-control-sm" id="orgSearchInput" placeholder="Buscar organización..." autocomplete="off">
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <ul class="list-unstyled mb-0" id="organizationList">
                                {% for org in organizations %}
                                <li><a class="dropdown-item organization-item" href="#" data-org-id="{{ org.id }}">{{ org.name }}</a></li>
                                {% endfor %}
                            </ul>
                            <div id="noResultsMessage" class="text-center p-2 d-none">
                                <span class="text-muted">No se encontraron resultados</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if token_info %}
<div class="row mb-4" id="authInfoPanel" style="display: none;">
    <div class="col-12">
        <div class="card shadow bg-dark">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-key me-2"></i> Información de Autenticación
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Access Token:</strong> <span>{{ token_info.access_token }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Refresh Token:</strong> <span>{{ token_info.refresh_token }}</span>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="mb-2">
                            <strong>Expira en:</strong> <span>{{ token_info.expires_in }}</span>
                        </div>
                    </div>
                    <div class="col-md-3 text-end">
                        <a href="{{ url_for('auth_setup') }}" class="btn btn-sm btn-outline-light">
                            <i class="fas fa-cog me-1"></i> Configurar autenticación
                        </a>
                    </div>
                </div>
                
                {% if auth_code_info %}
                <hr class="border-secondary">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <strong>Último código de autorización:</strong> 
                            <span class="user-select-all">{{ auth_code_info.code }}</span>
                            <span class="badge bg-info ms-1">{{ auth_code_info.full_length }} caracteres</span>
                        </div>
                    </div>
                    <div class="col-md-6 text-end">
                        <small class="text-muted">Este código fue utilizado para obtener el token actual. Guárdelo como referencia.</small>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Mapa -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-map-marker-alt me-2"></i> Ubicación de Máquinas
                </h5>
            </div>
            <div class="card-body p-0">
                <!-- Contenedor simplificado para mostrar mapa estático de imagen fija -->
                <div id="simple-map-container" class="position-relative" style="height: 500px; width: 100%; border-radius: 8px; overflow: hidden; background-color: #121212;">
                    
                    <!-- Mensaje inicial del mapa -->
                    <div id="map-initial-message" class="position-absolute top-0 left-0 w-100 h-100 d-flex align-items-center justify-content-center text-white">
                        <div class="text-center p-4">
                            <i class="fas fa-map-marked-alt mb-3" style="font-size: 3rem;"></i>
                            <h5>Seleccione una organización y máquina</h5>
                            <p class="text-muted">Se mostrará su ubicación en el mapa</p>
                        </div>
                    </div>
                    
                    <!-- Contenedor para Google Maps -->
                    <div id="map" class="position-absolute top-0 left-0 w-100 h-100" style="z-index: 1;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Máquinas y Alertas -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card shadow h-100">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-tractor me-2"></i> Máquinas
                </h5>
                <span class="badge bg-primary" id="machineCount">0</span>
            </div>
            <div class="card-body p-0">
                <div id="machineSearchContainer" class="p-2 border-bottom d-none">
                    <div class="position-relative">
                        <input type="text" class="form-control form-control-sm" id="machineSearchInput" placeholder="Buscar máquina..." autocomplete="off">
                        <div id="machineSearchLoading" class="position-absolute d-none" style="right: 10px; top: 5px;">
                            <div class="spinner-border spinner-border-sm text-secondary" role="status">
                                <span class="visually-hidden">Buscando...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="machineListContainer" class="list-group list-group-flush machine-list" style="max-height: 400px; overflow-y: auto;">
                    <div class="text-center py-5">
                        <div class="spinner-border text-secondary d-none" id="machineLoader" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="text-muted mt-3" id="emptyMachineMessage">Seleccione una organización para ver sus máquinas</p>
                    </div>
                </div>
                <div id="noMachineResultsMessage" class="text-center py-3 d-none">
                    <span class="text-muted">No se encontraron máquinas con ese criterio</span>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card shadow h-100" id="machine-alerts-card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bell me-2"></i> Alertas
                </h5>
            </div>
            <div class="card-body p-0">
                <!-- Mensaje cuando está vacío -->
                <div id="emptyAlertContainer" class="text-center py-5">
                    <p class="text-muted" id="emptyAlertMessage">Seleccione una máquina para ver sus alertas</p>
                </div>
                
                <!-- Contenedor para la lista de alertas -->
                <div id="alert-list-container" class="list-group list-group-flush alert-list" style="max-height: 400px; overflow-y: auto;" data-original-id="alertListContainer">
                    <!-- Las alertas se insertarán aquí dinámicamente -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detalles de la Máquina -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card shadow" id="machine-details-card" data-original-id="machineDetailCard">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i> Detalles de la Máquina
                </h5>
            </div>
            <div class="card-body">
                <div class="text-center py-4" id="machineDetailEmpty">
                    <p class="text-muted">Seleccione una máquina para ver sus detalles</p>
                </div>
                <div id="machine-details-content" class="d-none" data-original-id="machineDetailContent">
                    <div class="row">
                        <div class="col-md-6">
                            <h3 id="machineName">-</h3>
                            <p class="lead" id="machineModel">-</p>
                            <div class="mb-3">
                                <strong>Categoría:</strong> <span id="machineCategory">-</span>
                            </div>
                            
                            <!-- Widget de Horómetro -->
                            <div id="hourmeterWidget" class="card bg-dark mb-3 d-none">
                                <div class="card-body">
                                    <h6><i class="fas fa-tachometer-alt me-2"></i> Horómetro</h6>
                                    <div class="d-flex align-items-center mb-2">
                                        <div class="display-5 me-2" id="hourmeterValue">0.0 hrs</div>
                                    </div>
                                    <small class="text-muted" id="hourmeterLastUpdate">Última actualización: N/A</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-dark location-card">
                                <div class="card-body">
                                    <h6>Última ubicación conocida</h6>
                                    <div class="mb-2">
                                        <strong>Latitud:</strong> <span id="machineLatitude">-</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong>Longitud:</strong> <span id="machineLongitude">-</span>
                                    </div>
                                    <div>
                                        <strong>Actualizado:</strong> <span id="machineLocationUpdate">-</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Gráfico de resumen de alertas -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i> Resumen de Alertas por Severidad
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <canvas id="alertsSeverityChart"></canvas>
                    </div>
                    <div class="col-md-6">
                        <canvas id="alertsTimelineChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabla de Alertas -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i> Historial de Alertas
                </h5>
                <button class="btn btn-sm btn-outline-success" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-1"></i> Exportar a Excel
                </button>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="alertsTable" class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Severidad</th>
                                <th>Descripción</th>
                                <th>DTC</th>
                                <th>Estado</th>
                            </tr>
                        </thead>
                        <tbody id="alertsTableBody">
                            <!-- Las filas se agregarán dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<!-- Carga de Google Maps API con la API key proporcionada -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBxQpMnELsUyNLJuMGloCRu2ssQ5zGplmc&callback=initMap" async defer></script>

<script>
    // Variables globales para el mapa
    let map;
    let markers = {};
    let infoWindow;
    
    // Inicializar el mapa 
    function initMap() {
        console.log("Inicializando Google Maps...");
        
        try {
            // Crear la ventana de información compartida para todos los marcadores
            infoWindow = new google.maps.InfoWindow();
            
            // Obtener el elemento del mapa
            const mapElement = document.getElementById('map');
            if (!mapElement) {
                console.error("Error: No se encontró el elemento del mapa 'map'");
                return;
            }
            
            // Asegurarse de que el elemento tenga dimensiones
            if (mapElement.offsetWidth === 0 || mapElement.offsetHeight === 0) {
                console.warn("El elemento del mapa tiene dimensiones cero. Estableciendo dimensiones explícitas.");
                mapElement.style.height = "500px";
                mapElement.style.width = "100%";
            }
            
            // Crear mapa centrado en una ubicación predeterminada (centro de Chile)
            map = new google.maps.Map(mapElement, {
                center: { lat: -33.4489, lng: -70.6693 }, // Santiago, Chile
                zoom: 5,
                mapTypeId: google.maps.MapTypeId.SATELLITE, // Vista satélite por defecto
                mapTypeControl: true,
                fullscreenControl: true,
                streetViewControl: false,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
                },
                // Estilo oscuro para hacer juego con el tema de la aplicación
                styles: [
                    { elementType: "geometry", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.stroke", stylers: [{ color: "#242f3e" }] },
                    { elementType: "labels.text.fill", stylers: [{ color: "#746855" }] },
                    {
                        featureType: "administrative.locality",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "poi",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "poi.park",
                        elementType: "geometry",
                        stylers: [{ color: "#263c3f" }],
                    },
                    {
                        featureType: "poi.park",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#6b9a76" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry",
                        stylers: [{ color: "#38414e" }],
                    },
                    {
                        featureType: "road",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#212a37" }],
                    },
                    {
                        featureType: "road",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#9ca5b3" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry",
                        stylers: [{ color: "#746855" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "geometry.stroke",
                        stylers: [{ color: "#1f2835" }],
                    },
                    {
                        featureType: "road.highway",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#f3d19c" }],
                    },
                    {
                        featureType: "transit",
                        elementType: "geometry",
                        stylers: [{ color: "#2f3948" }],
                    },
                    {
                        featureType: "transit.station",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#d59563" }],
                    },
                    {
                        featureType: "water",
                        elementType: "geometry",
                        stylers: [{ color: "#17263c" }],
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.fill",
                        stylers: [{ color: "#515c6d" }],
                    },
                    {
                        featureType: "water",
                        elementType: "labels.text.stroke",
                        stylers: [{ color: "#17263c" }],
                    },
                ]
            });
            
            // Ocultar el mensaje inicial cuando el mapa esté listo
            const initialMessage = document.getElementById('map-initial-message');
            if (initialMessage) {
                initialMessage.style.display = 'flex'; // Mantenerlo visible hasta que seleccionen una máquina
            }
            
            console.log("Mapa de Google Maps inicializado correctamente");
            
        } catch (error) {
            console.error("Error al inicializar el mapa:", error);
            console.error("Detalles del error:", error.message);
            console.error("Stack trace:", error.stack);
            
            displayMapError("Error al inicializar el mapa: " + error.message);
        }
    }
    
    /**
     * Añade máquinas al mapa con marcadores
     * @param {Array} machines - Lista de máquinas para mostrar en el mapa
     */
    function addMachinesToMap(machines) {
        console.log(`Añadiendo ${machines.length} máquinas al mapa`);
        
        // Guardar las máquinas para uso posterior
        window.lastLoadedMachines = machines;
        
        // Ocultar mensaje inicial
        const initialMessage = document.getElementById('map-initial-message');
        if (initialMessage) initialMessage.style.display = 'none';
        
        // Si el mapa no está inicializado, no continuar
        if (!map) {
            console.error("El mapa no está inicializado");
            return;
        }
        
        // Limpiar marcadores existentes
        clearMapMarkers();
        
        // Crear límites para ajustar la vista
        const bounds = new google.maps.LatLngBounds();
        let validLocations = 0;
        
        // Limitar el número de marcadores para evitar sobrecargar el mapa
        const MAX_MARKERS = 50;
        let markersAdded = 0;
        let hasLimitedMarkers = false;
        
        // Primero añadir la máquina seleccionada si existe
        if (window.selectedMachineId) {
            const selectedMachine = machines.find(m => m.id === window.selectedMachineId);
            if (selectedMachine && selectedMachine.location && 
                selectedMachine.location.latitude && selectedMachine.location.longitude) {
                addSingleMachineToMap(selectedMachine, bounds);
                validLocations++;
                markersAdded++;
            }
        }
        
        // Luego añadir el resto hasta el límite
        for (const machine of machines) {
            // Si ya tenemos la máquina seleccionada, saltarla
            if (window.selectedMachineId && machine.id === window.selectedMachineId) {
                continue;
            }
            
            if (machine.location && machine.location.latitude && machine.location.longitude) {
                // Si alcanzamos el límite, detenernos
                if (markersAdded >= MAX_MARKERS) {
                    hasLimitedMarkers = true;
                    break;
                }
                
                addSingleMachineToMap(machine, bounds);
                validLocations++;
                markersAdded++;
            }
        }
        
        // Si tenemos ubicaciones válidas, ajustar el mapa a esos límites
        if (validLocations > 0) {
            map.fitBounds(bounds);
            
            // Limitar el zoom máximo para no acercarse demasiado si solo hay un marcador
            if (validLocations === 1) {
                google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
                    if (map.getZoom() > 15) map.setZoom(15);
                });
            }
        }
        
        // Si hemos limitado los marcadores, mostrar un mensaje
        if (hasLimitedMarkers) {
            // Crear un control de información personalizado
            const limitInfoDiv = document.createElement('div');
            limitInfoDiv.className = 'map-info-control';
            limitInfoDiv.innerHTML = `
                <div class="alert alert-info p-2 m-0" style="font-size: 0.8rem; opacity: 0.9;">
                    <i class="fas fa-info-circle"></i> 
                    Mostrando ${markersAdded} de ${machines.filter(m => m.location && 
                    m.location.latitude && m.location.longitude).length} ubicaciones.
                </div>`;
            
            // Estilos para el control
            limitInfoDiv.style.margin = '10px';
            limitInfoDiv.style.padding = '5px';
            limitInfoDiv.style.backgroundColor = 'white';
            limitInfoDiv.style.border = '1px solid #ccc';
            limitInfoDiv.style.borderRadius = '4px';
            limitInfoDiv.style.boxShadow = '0 2px 6px rgba(0,0,0,.3)';
            
            // Añadir el control al mapa
            map.controls[google.maps.ControlPosition.BOTTOM_LEFT].push(limitInfoDiv);
        }
        
        console.log(`Añadidos ${markersAdded} marcadores al mapa`);
    }
    
    /**
     * Añade una sola máquina al mapa
     * @param {Object} machine - Objeto con datos de la máquina
     * @param {Object} bounds - Objeto LatLngBounds para expandir
     */
    function addSingleMachineToMap(machine, bounds) {
        // Crear posición para Google Maps
        const position = {
            lat: parseFloat(machine.location.latitude),
            lng: parseFloat(machine.location.longitude)
        };
        
        // Determinar si esta máquina está seleccionada
        const isSelected = window.selectedMachineId && machine.id === window.selectedMachineId;
        
        // Obtener el color según el tipo de máquina
        let iconUrl;
        
        // Si está seleccionada, usar ícono dorado
        if (isSelected) {
            iconUrl = 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png';
        } 
        // Si la máquina tiene alertas, seleccionar ícono según la severidad de la alerta
        else if (window.machineAlerts && machine.id && window.machineAlerts[machine.id] && 
                 window.machineAlerts[machine.id].length > 0) {
            
            // Determinar la alerta con mayor severidad
            const alerts = window.machineAlerts[machine.id];
            let highestSeverity = 'info';
            
            for (const alert of alerts) {
                if (alert.severity === 'high') {
                    highestSeverity = 'high';
                    break;
                } else if (alert.severity === 'medium' && highestSeverity !== 'high') {
                    highestSeverity = 'medium';
                }
            }
            
            // Seleccionar ícono por severidad
            switch (highestSeverity) {
                case 'high':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/red-dot.png';
                    break;
                case 'medium':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png';
                    break;
                case 'low':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/gray-dot.png';
                    break;
                case 'info':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
                    break;
                default:
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/green-dot.png';
            }
        } 
        // Si no hay alertas, usar ícono según el tipo de máquina
        else {
            // Obtener categoría
            const category = machine.category || 'UNKNOWN';
            
            // Seleccionar ícono según la categoría
            switch (category) {
                case 'Tractor':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/green-dot.png';
                    break;
                case 'Harvester':
                case 'Tracked Harvester':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/red-dot.png';
                    break;
                case 'Backhoes':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/yellow-dot.png';
                    break;
                case 'Excavator':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png';
                    break;
                case 'Skidder':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/purple-dot.png';
                    break;
                case 'Truck':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png';
                    break;
                case 'Vehicle':
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/lightblue-dot.png';
                    break;
                default:
                    iconUrl = 'https://maps.google.com/mapfiles/ms/icons/green-dot.png';
            }
        }
        
        // Crear el marcador con ícono personalizado
        const marker = new google.maps.Marker({
            position: position,
            map: map,
            title: machine.name || `Máquina ${machine.id}`,
            icon: {
                url: iconUrl,
                scaledSize: new google.maps.Size(isSelected ? 42 : 35, isSelected ? 42 : 35), // Tamaño más grande para seleccionadas
                origin: new google.maps.Point(0, 0),
                anchor: new google.maps.Point(isSelected ? 21 : 17.5, isSelected ? 42 : 35)
            },
            zIndex: isSelected ? 1000 : 1 // Mayor zIndex para máquinas seleccionadas
        });
        
        // Crear contenido para la ventana de información
        const popupContent = createMachinePopupContent(machine);
        
        // Añadir evento click para mostrar la información y seleccionar la máquina
        marker.addListener('click', function() {
            infoWindow.setContent(popupContent);
            infoWindow.open(map, marker);
            
            // Seleccionar esta máquina cuando se hace clic en el marcador
            if (typeof selectMachine === 'function') {
                selectMachine(machine.id);
            }
        });
        
        // Almacenar el marcador con el ID de máquina como clave
        markers[machine.id] = marker;
        
        // Extender los límites para incluir este marcador
        bounds.extend(position);
    }
    
    /**
     * Crea el contenido HTML para la ventana de información de una máquina
     * @param {Object} machine - Objeto con datos de la máquina
     * @returns {string} HTML formateado para la ventana de información
     */
    function createMachinePopupContent(machine) {
        // Obtener información de ubicación y formatear datos
        const timestamp = machine.location && machine.location.timestamp ?
            new Date(machine.location.timestamp).toLocaleString() : 'Desconocido';
        
        // Formatear coordenadas con precisión de 6 decimales
        const latitude = machine.location && machine.location.latitude ? 
            parseFloat(machine.location.latitude).toFixed(6) : 'No disponible';
        const longitude = machine.location && machine.location.longitude ? 
            parseFloat(machine.location.longitude).toFixed(6) : 'No disponible';
        
        // Obtener modelo y tipo de máquina
        let modelText = 'Modelo desconocido';
        if (machine.model) {
            if (typeof machine.model === 'object' && machine.model.name) {
                modelText = machine.model.name;
            } else if (typeof machine.model === 'string') {
                modelText = machine.model;
            }
        }
        
        // Crear HTML para la ventana de información
        return `
            <div class="map-info-window">
                <h5>${machine.name || `Máquina ${machine.id}`}</h5>
                <p><strong>Modelo:</strong> ${modelText}</p>
                <p><strong>Categoría:</strong> ${machine.category || 'Sin categoría'}</p>
                <p><strong>Ubicación:</strong><br>
                   Lat: ${latitude}, Lng: ${longitude}</p>
                <p><strong>Última actualización:</strong><br>
                   ${timestamp}</p>
                <div class="text-center mt-2">
                    <button class="btn btn-sm btn-primary" onclick="selectMachine('${machine.id}')">
                        Ver detalles
                    </button>
                </div>
            </div>
        `;
    }
    
    /**
     * Limpia todos los marcadores del mapa
     */
    function clearMapMarkers() {
        console.log("Limpiando todos los marcadores del mapa");
        
        // Eliminar cada marcador del mapa
        for (const machineId in markers) {
            if (markers.hasOwnProperty(machineId)) {
                markers[machineId].setMap(null);
            }
        }
        
        // Reiniciar el objeto de marcadores
        markers = {};
        
        // Cerrar la ventana de información si está abierta
        if (infoWindow) {
            infoWindow.close();
        }
    }
    
    /**
     * Muestra un mensaje de error en el área del mapa
     * @param {string} message - Mensaje de error a mostrar
     */
    function displayMapError(message) {
        console.error("Error del mapa:", message);
        
        // Crear un div para mostrar el error
        const errorDiv = document.createElement('div');
        errorDiv.className = 'position-absolute top-0 left-0 w-100 h-100 d-flex align-items-center justify-content-center bg-dark bg-opacity-75';
        errorDiv.style.zIndex = '1000';
        errorDiv.innerHTML = `
            <div class="text-center p-4">
                <i class="fas fa-exclamation-triangle mb-3 text-warning" style="font-size: 3rem;"></i>
                <h5 class="text-white">${message}</h5>
            </div>
        `;
        
        // Agregar al contenedor del mapa
        const mapContainer = document.getElementById('map').parentNode;
        mapContainer.appendChild(errorDiv);
    }
    
    /**
     * Selecciona una máquina específica en el mapa y centra la vista
     * @param {string} machineId - ID de la máquina a seleccionar
     */
    function selectMachineOnMap(machineId) {
        console.log("Seleccionando máquina en mapa:", machineId);
        
        // Ocultar mensaje inicial
        const initialMessage = document.getElementById('map-initial-message');
        if (initialMessage) initialMessage.style.display = 'none';
        
        // Verificar si el mapa está inicializado
        if (!map) {
            console.error("El mapa no está inicializado");
            return;
        }
        
        // Si ya tenemos el marcador, centramos el mapa en él
        if (markers[machineId]) {
            // Centrar en el marcador
            map.setCenter(markers[machineId].getPosition());
            map.setZoom(15);
            
            // Abrir la ventana de información
            const machine = (window.lastLoadedMachines || []).find(m => m.id === machineId);
            if (machine) {
                infoWindow.setContent(createMachinePopupContent(machine));
                infoWindow.open(map, markers[machineId]);
            }
            
            return;
        }
        
        // Si no, buscamos la máquina y creamos un nuevo marcador
        const machine = (window.lastLoadedMachines || []).find(m => m.id === machineId);
        if (machine && machine.location && machine.location.latitude && machine.location.longitude) {
            // Crear límites
            const bounds = new google.maps.LatLngBounds();
            
            // Añadir al mapa
            addSingleMachineToMap(machine, bounds);
            
            // Centrar en la ubicación
            map.fitBounds(bounds);
            map.setZoom(15);
            
            // Mostrar la ventana de información
            infoWindow.setContent(createMachinePopupContent(machine));
            infoWindow.open(map, markers[machineId]);
        } else {
            console.error("No se encontró la máquina o no tiene ubicación válida");
            
            // Intentar cargar la información de la máquina desde la API
            fetch(`/api/machine/${machineId}`, {
                credentials: 'same-origin',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Error al cargar detalles de máquina');
                }
                return response.json();
            })
            .then(machine => {
                if (machine && machine.location && 
                    machine.location.latitude && machine.location.longitude) {
                    
                    // Crear límites
                    const bounds = new google.maps.LatLngBounds();
                    
                    // Añadir al mapa
                    addSingleMachineToMap(machine, bounds);
                    
                    // Centrar en la ubicación
                    map.fitBounds(bounds);
                    map.setZoom(15);
                    
                    // Mostrar la ventana de información
                    infoWindow.setContent(createMachinePopupContent(machine));
                    infoWindow.open(map, markers[machineId]);
                } else {
                    displayMapError("La máquina no tiene datos de ubicación disponibles");
                }
            })
            .catch(error => {
                console.error("Error cargando máquina para el mapa:", error);
                displayMapError("Error al cargar la ubicación: " + error.message);
            });
        }
    }
    
    // Modificar la función global selectMachine para mostrar el mapa
    window.originalSelectMachine = window.selectMachine;
    window.selectMachine = function(machineId) {
        // Primero ejecutamos todas las funciones del sistema original
        if (typeof window.originalSelectMachine === 'function') {
            try {
                window.originalSelectMachine(machineId);
            } catch (error) {
                console.error("Error en la función original selectMachine:", error);
            }
        } else {
            console.warn("La función originalSelectMachine no está disponible");
        }
        
        // Luego centramos el mapa en esta máquina
        try {
            selectMachineOnMap(machineId);
        } catch (error) {
            console.error("Error al mostrar máquina en mapa:", error);
        }
    };
    
    // Exponer funciones globalmente para que puedan ser utilizadas desde otros scripts
    window.addMachinesToMap = addMachinesToMap;
    window.clearMapMarkers = clearMapMarkers;
    window.selectMachineOnMap = selectMachineOnMap;
</script>

<!-- Estilos para el mapa -->
<style>
    #simple-map-container {
        position: relative;
        overflow: hidden;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        border-radius: 8px;
    }
    
    #map {
        border-radius: 8px;
    }
    
    .map-info-window {
        padding: 10px;
        max-width: 300px;
    }
    
    .gm-style-iw-d {
        overflow: hidden !important;
    }
    
    .gm-style-iw-c {
        padding: 12px !important;
        border-radius: 8px !important;
    }
</style>

<!-- Incluir el resto de los scripts de la aplicación -->
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script>
// Script para compatibilidad de IDs entre CSS y JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Mapeo de IDs originales a nuevos IDs
    const idMap = {
        'machineDetailCard': 'machine-details-card',
        'machineDetailContent': 'machine-details-content',
        'alertListContainer': 'alert-list-container'
    };
    
    // Reemplazar el método getElementById original
    const originalGetElementById = document.getElementById;
    document.getElementById = function(id) {
        // Si el ID está en nuestro mapeo, intenta obtener el elemento con el nuevo ID
        if (idMap[id]) {
            const element = originalGetElementById.call(document, idMap[id]);
            if (element) {
                return element;
            }
        }
        // Si no está en el mapeo o no se encontró con el nuevo ID, usa el método original
        return originalGetElementById.call(document, id);
    };
});
</script>
{% endblock %}
