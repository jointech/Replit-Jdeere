
{% extends 'base.html' %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="display-5">Historial de Ubicaciones</h1>
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle" type="button" id="organizationDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fas fa-building me-2"></i> Seleccionar Organización
                </button>
                <div class="dropdown-menu dropdown-menu-end p-2" aria-labelledby="organizationDropdown" style="width: 300px;">
                    <div class="mb-2">
                        <input type="text" class="form-control form-control-sm" id="orgSearchInput" placeholder="Buscar organización..." autocomplete="off">
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        <ul class="list-unstyled mb-0" id="organizationList">
                            {% for org in organizations %}
                            <li><a class="dropdown-item organization-item" href="#" data-org-id="{{ org.id }}">{{ org.name }}</a></li>
                            {% endfor %}
                        </ul>
                        <div id="noResultsMessage" class="text-center py-2 d-none">
                            <small class="text-muted">No se encontraron resultados</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i> Últimas Ubicaciones Reportadas
                    </h5>
                    <button class="btn btn-sm btn-outline-success" onclick="exportLocationHistory()">
                        <i class="fas fa-file-excel me-1"></i> Exportar a Excel
                    </button>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="date" class="form-control" id="startDate" onchange="filterLocationsByDate()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-calendar"></i></span>
                            <input type="date" class="form-control" id="endDate" onchange="filterLocationsByDate()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="clearDateFilters()">
                            <i class="fas fa-eraser me-2"></i>Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table id="locationHistoryTable" class="table table-dark table-hover">
                        <thead>
                            <tr>
                                <th>VIN</th>
                                <th>Nombre</th>
                                <th>Última Transmisión</th>
                                <th>Latitud</th>
                                <th>Longitud</th>
                            </tr>
                        </thead>
                        <tbody id="locationHistoryTableBody">
                            <!-- Datos serán cargados dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configurar la búsqueda de organizaciones
    setupOrganizationSearch();
    
    // Inicializar selección de organización
    setupOrganizationSelection();
});

let allLocationData = []; // Variable global para almacenar todos los datos

function loadLocationHistory(organizationId) {
    fetch(`/api/location-history/${organizationId}`)
        .then(response => response.json())
        .then(data => {
            allLocationData = data; // Guardar datos completos
            renderLocationData(data); // Renderizar datos iniciales
        })
        .catch(error => console.error('Error:', error));
}

function renderLocationData(data) {
    const tbody = document.getElementById('locationHistoryTableBody');
    tbody.innerHTML = '';
    
    data.forEach(location => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${location.vin}</td>
            <td>${location.name}</td>
            <td>${new Date(location.timestamp).toLocaleString()}</td>
            <td>${location.latitude}</td>
            <td>${location.longitude}</td>
        `;
        tbody.appendChild(row);
    });
}

function filterLocationsByDate() {
    const startDate = document.getElementById('startDate').value;
    const endDate = document.getElementById('endDate').value;
    
    if (!startDate && !endDate) {
        renderLocationData(allLocationData);
        return;
    }
    
    const start = startDate ? new Date(startDate) : new Date(0);
    const end = endDate ? new Date(endDate) : new Date();
    // Ajustar end para incluir todo el día seleccionado
    end.setHours(23, 59, 59, 999);
    
    const filteredData = allLocationData.filter(location => {
        const locationDate = new Date(location.timestamp);
        return locationDate >= start && locationDate <= end;
    });
    
    renderLocationData(filteredData);
}

function clearDateFilters() {
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    renderLocationData(allLocationData);
}

// Configurar la selección de organizaciones
function setupOrganizationSelection() {
    // También agregar un controlador de eventos al elemento padre para manejar delegación de eventos
    document.getElementById('organizationList').addEventListener('click', function(e) {
        // Verificar si el elemento clicado o alguno de sus padres es un .organization-item
        const item = e.target.closest('.organization-item');
        if (item) {
            e.preventDefault();
            const orgId = item.getAttribute('data-org-id');
            const orgName = item.textContent.trim();

            console.log(`Organización seleccionada: ${orgName} (${orgId})`);

            // Update dropdown button with organization name but keep the icon
            const dropdownButton = document.getElementById('organizationDropdown');
            if (dropdownButton) {
                dropdownButton.innerHTML = `<i class="fas fa-building me-2"></i> ${orgName}`;
            } else {
                console.error("No se encontró el elemento dropdownButton");
            }

            // Cargar historial de ubicación para esta organización
            loadLocationHistory(orgId);

            // Cerrar menú desplegable
            const dropdown = bootstrap.Dropdown.getInstance(dropdownButton);
            if (dropdown) {
                dropdown.hide();
            }
        }
    });
}

// Configurar el buscador de organizaciones
function setupOrganizationSearch() {
    const searchInput = document.getElementById('orgSearchInput');
    if (!searchInput) {
        console.error("No se encontró el elemento de búsqueda");
        return;
    }

    // Variables para optimización
    let debounceTimer;
    const DEBOUNCE_DELAY = 300; // ms

    // Manejar el evento de entrada para filtrar la lista con debounce
    searchInput.addEventListener('input', function() {
        // Cancelar el timer anterior
        clearTimeout(debounceTimer);

        // Establecer un nuevo timer
        debounceTimer = setTimeout(() => {
            const searchTerm = this.value.toLowerCase().trim();
            const organizationItems = document.querySelectorAll('.organization-item');
            const noResultsMessage = document.getElementById('noResultsMessage');
            let matchCount = 0;

            // Recorrer cada elemento y mostrar/ocultar según el término de búsqueda
            organizationItems.forEach(item => {
                const orgName = item.textContent.toLowerCase();
                const orgId = item.getAttribute('data-org-id');
                const listItem = item.closest('li');

                // Verificar si el nombre o ID de la organización contiene el término de búsqueda
                if (orgName.includes(searchTerm) || (orgId && orgId.includes(searchTerm))) {
                    if (listItem) {
                        listItem.style.display = '';
                        matchCount++;
                    }
                } else {
                    if (listItem) {
                        listItem.style.display = 'none';
                    }
                }
            });

            // Mostrar/ocultar mensaje de "sin resultados"
            if (noResultsMessage) {
                noResultsMessage.classList.toggle('d-none', !(matchCount === 0 && searchTerm.length > 0));
            }
        }, DEBOUNCE_DELAY);
    });

    // Prevenir que el dropdown se cierre al hacer clic en el campo de búsqueda
    searchInput.addEventListener('click', function(e) {
        e.stopPropagation();
    });

    // Al abrir el dropdown, enfocar automáticamente el campo de búsqueda
    const dropdownButton = document.getElementById('organizationDropdown');
    if (dropdownButton) {
        dropdownButton.addEventListener('shown.bs.dropdown', function() {
            searchInput.focus();
        });

        // Limpiar la búsqueda cuando se cierra el dropdown
        dropdownButton.addEventListener('hidden.bs.dropdown', function() {
            searchInput.value = '';
            // Restaurar la visibilidad de todos los elementos
            const event = new Event('input');
            searchInput.dispatchEvent(event);
        });
    }
}

function exportLocationHistory() {
    const table = document.getElementById('locationHistoryTable');
    const rows = Array.from(table.querySelectorAll('tr'));
    
    let csvContent = "data:text/csv;charset=utf-8,";
    
    // Agregar encabezados
    const headers = Array.from(table.querySelectorAll('thead th'))
        .map(header => header.textContent);
    csvContent += headers.join(',') + "\n";
    
    // Agregar datos
    const data = Array.from(table.querySelectorAll('tbody tr'))
        .map(row => Array.from(row.querySelectorAll('td'))
            .map(cell => `"${cell.textContent}"`)
            .join(','));
    csvContent += data.join('\n');
    
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement('a');
    link.setAttribute('href', encodedUri);
    link.setAttribute('download', 'location_history.csv');
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}
</script>
{% endblock %}
